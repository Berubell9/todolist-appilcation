name: Continuous Integration (CI)

on:
  push:
    branches: [main]

# เปิดสิทธิ์เขียนคอนเทนต์ (commit/push/tag)
permissions:
  contents: write

jobs:
  test-api:
    name: Test API
    runs-on: ubuntu-latest

    # ---------- MySQL ----------
    # เพิ่ม MySQL Service เพื่อใช้ทดสอบ Backend
    services:
      mysql:
        image: mysql:8.4
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.DB_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.DB_NAME }}
          MYSQL_USER: ${{ secrets.DB_USER }}
          MYSQL_PASSWORD: ${{ secrets.DB_PASSWORD }}
        ports:
          - 3306:3306

    steps:
      # Checkout code from the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: npm
          cache-dependency-path: |
            my-app/package-lock.json
            api/package-lock.json

      # ---------- Frontend ----------
      - name: Install dependencies (frontend)
        working-directory: ./my-app
        run: npm ci

      # ช่วยตรวจสอบไวยกรณ์ เและทำให้โค้ดเป็นมาตรฐาน เช่น การเว้นวรรค หรือเครื่องหมาย
      # ใช้เครื่องมือ eslint
      - name: Run Linting tests (frontend)
        working-directory: ./my-app
        run: npm run lint 

      - name: Run Build (frontend)
        working-directory: ./my-app
        run: npm run build

      # ---------- Backend ----------
      - name: Install dependencies (backend)
        working-directory: ./api
        run: npm ci

      # รอให้ MySQL พร้อมก่อน เนื่องจาก อาจจะขึ้นสถานะ Running เเล้ว เเต่เมื่อเอา schema.sql เข้าไปเลยจะเกิด ERROR 
      - name: Wait for DB healthy
        run: |
          sudo apt-get update && sudo apt-get install -y mysql-client

          # เป็นคำสั่งเช็คว่า MySQL ตอบกลับได้หรือยัง มันจะตอบ mysqld is alive ถ้าเชื่อมต่อได้
          # ลองเชื่อมต่อสูงสุด 40 ครั้ง ห่างกันครั้งละ 2 วินาที
          for i in {1..20}; do
            if mysqladmin ping -h 127.0.0.1 -uroot -p"${{ secrets.DB_ROOT_PASSWORD }}" --silent; then
              echo "MySQL is healthy"; break
            fi
            echo "⏳ waiting for mysql..."; sleep 2
          done
      
      # หลังจาก MySQL พร้อมแล้ว ให้นำไฟล์ schema.sql เข้า MySQL Container
      - name: Seed schema
        run: mysql -h 127.0.0.1 -P 3306 -u"${{ secrets.DB_USER }}" -p"${{ secrets.DB_PASSWORD }}" "${{ secrets.DB_NAME }}" < ./sql/schema.sql
      # ลองส่ง HTTP request มาที่ API  โดยถ้าผ่านจะแสดง respond 200
      - name: Test (backend)
        working-directory: ./api
        env:
          NODE_ENV: test
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: npm test

# Build & Push Images to NIPA Cloud Registry
  build-and-push:
    name: Build & Push Images to Registry
    runs-on: ubuntu-latest

    # จะรันต่อเมื่อขั้นตอนด้านบน หรือ test-api ผ่านทั้งหมด
    needs: test-api

    steps:
      # Checkout code from the repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # คำนวณแท็กใหม่แบบ 1.0.X ของ images (บัมพ์ patch)
      - name: Compute next image tag
        id: semver
        shell: bash
        run: |
          # หาแท็กล่าสุด (ถ้าไม่มี ให้เริ่มที่ 1.0.0)
          LAST_TAG=$(git tag --list | sort -V | tail -n1)
          if [[ -z "$LAST_TAG" ]]; then
            LAST_TAG="1.0.0"
          fi
          echo "Last tag : $LAST_TAG"

          # แยกส่วน Major.Minor.Patch
          IFS='.' read -r MA MI PA <<< "$LAST_TAG"
          if [[ -z "$MA" || -z "$MI" || -z "$PA" ]]; then
            echo "รูปแบบ tag ล่าสุดไม่ถูกต้อง (ต้องเป็น X.Y.Z): $LAST_TAG"
            exit 1
          fi

          # ถ้า patch ถึง 9 → เพิ่ม minor แล้วรีเซ็ต patch = 0
          if (( PA >= 9 )); then
            PA=0
            MI=$((MI+1))
          else
            PA=$((PA+1))
          fi

          NEXT_TAG="$MA.$MI.$PA"
          echo "Next tag : $NEXT_TAG"
          echo "NEXT_TAG=$NEXT_TAG" >> $GITHUB_ENV

      # Set up Docker
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Login to NIPA Cloud Registry
      - name: Login to NIPA Cloud Registry
        uses: docker/login-action@v3
        with:
          registry: registry.nipa.cloud
          username: ${{ secrets.NIPA_USERNAME }}
          password: ${{ secrets.NIPA_PASSWORD }}

      # ===== Build & Push Frontend =====
      - name: Build and Push Frontend to NIPA Cloud Registry
        uses: docker/build-push-action@v5
        with:
          context: ./my-app
          file: ./my-app/Dockerfile
          push: true
          tags: |
            registry.nipa.cloud/todolist-app/frontend:${{ env.NEXT_TAG }}
            registry.nipa.cloud/todolist-app/frontend:latest

      # ===== Build & Push Backend =====
      - name: Build and Push Backend to NIPA Cloud Registry
        uses: docker/build-push-action@v5
        with:
          context: ./api
          file: ./api/Dockerfile
          push: true
          tags: |
            registry.nipa.cloud/todolist-app/backend:${{ env.NEXT_TAG }}
            registry.nipa.cloud/todolist-app/backend:latest

  update-tags:
    name: Update Tags
    runs-on: ubuntu-latest

    # จะรันต่อเมื่อขั้นตอนด้านบน หรือ test-api ผ่านทั้งหมด
    needs: build-and-push

    steps:
      # Update tag images the K8s Manifest Files to kustomization.yaml
      - name: Update tag images to Kustomize
        uses: mikefarah/yq@v4
        with:
          cmd: |
            echo "Updating tag images to kustomization.yaml"
            yq -i '
              (.images[] | select(.name=="registry.nipa.cloud/todolist-app/frontend").newTag) = strenv(NEXT_TAG) |
              (.images[] | select(.name=="registry.nipa.cloud/todolist-app/backend").newTag) = strenv(NEXT_TAG)
            ' manifest/kustomization.yaml

      # Update tag images to .env Files
      - name: Update tag in .env
        shell: bash
        run: |
          ENV_FILE=".env"
          echo "Updating WEB_TAG and API_TAG to ${NEXT_TAG}"
          sed -i "s|^WEB_TAG=.*|WEB_TAG=${NEXT_TAG}|g" "$ENV_FILE"
          sed -i "s|^API_TAG=.*|API_TAG=${NEXT_TAG}|g" "$ENV_FILE"
          cat $ENV_FILE


      # Update Git tag and commit
      - name: Commit changes & push tag
        env:
          NEXT_TAG: ${{ env.NEXT_TAG }}
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add manifest/kustomization.yaml .env 2>/dev/null || true
          git commit -m "chore(ci): bump image tag to ${NEXT_TAG}" || echo "no changes to commit"

          # สร้าง Git tag 1.0.X และ push
          git tag "${NEXT_TAG}" || echo "tag already exists?"
          git push origin HEAD:main
          git push origin "${NEXT_TAG}"